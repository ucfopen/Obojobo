require './editor.scss'

Viewer = require './viewer'

ObojoboDraft = window.ObojoboDraft

FocusableCommandHandler = ObojoboDraft.command.FocusableCommandHandler
Chunk = ObojoboDraft.models.Chunk
FocusableChunk = ObojoboDraft.components.FocusableChunk
SingleInputBubble = ObojoboDraft.components.modal.bubble.SingleInputBubble
Keyboard = ObojoboDraft.page.Keyboard
DeleteButton = ObojoboDraft.components.DeleteButton
EditButton = ObojoboDraft.components.EditButton

commandHandler = new FocusableCommandHandler()

YouTube = React.createClass
	statics:
		type: 'ObojoboDraft.Chunks.YouTube'
		register: ->
			OBO.registerChunk YouTube, {
				insertItem:
					label: 'YouTube Video'
					icon: require 'svg-url?noquotes!./assets/insert-icon.svg'
					onInsert: ObojoboDraft.chunk.insertWithText
			}
		label: 'YouTube Video'
		getCommandHandler: -> commandHandler

		# OBONODE DATA METHODS
		# ================================================
		createNewNodeData: ->
			videoId: null

		cloneNodeData: (data) ->
			videoId: data.videoId

		# SERIALIZATION/DECODE METHODS
		# ================================================
		createNodeDataFromDescriptor: (descriptor) ->
			videoId: descriptor.content.videoId

		getDataDescriptor: (chunk) ->
			videoId: chunk.componentContent.videoId

		# HTML METHODS
		# ================================================
		createNewNodesFromElement: (el) ->
			console.clear()
			console.log 'yt', el

			data = null

			if el.firstElementChild?.getAttribute?('data-video-id')
				data =
					videoId: el.firstElementChild.getAttribute('data-video-id')

			console.log data
			[Chunk.create @, data]

	getInitialState: ->
		userVideoId: @props.chunk.componentContent.videoId

	startEditing: ->
		@props.editChunk @props.chunk

	# onInputChange: (event) ->
	# 	console.log 'change', event


	# onSetVideoId: ->
	# 	@props.chunk.markDirty()
	# 	@props.chunk.componentContent.videoId = @state.userVideoId
	# 	@setState { chunk:@props.chunk }
	# 	@props.activateFn null

	# renderOLD: ->
	# 	data = @props.chunk.componentContent

	# 	if @state.active
	# 		childElements =
	# 			React.createElement 'div', null, [
	# 				React.createElement('input', { type:'text', value:@state.userVideoId, onChange:@onInputChange }),
	# 				React.createElement('button', { onClick:@onSetVideoId }, 'Submit!')
	# 			],
	# 			React.createElement 'iframe', { width:560, height:315, src:"https://www.youtube.com/embed/#{data.videoId}", frameBorder:0, allowFullScreen:true }, null
	# 	else
	# 		childElements = React.createElement 'img', { width:'100%', height:'auto', style:{ position:'absolute', left:0, top:'50%', transform:'translateY(-50%)'}, src:"https://i.ytimg.com/vi/#{data.videoId}/hqdefault.jpg" }

	# 	React.createElement 'div', { 'data-video-id':data.videoId, onClick:@onClick, style: { width:560, height:315, overflow:'hidden', position:'relative' } }, childElements

	onChange: (newValue) ->
		console.log 'YT on Change', newValue
		# @props.chunk.markDirty()
		# data = @props.chunk.componentContent
		# data.videoId = newValue
		@setState { userVideoId:newValue }

	onClose: ->
		@props.chunk.markDirty()
		@props.chunk.componentContent.videoId = @state.userVideoId

		# @props.setTextMode on
		@props.stopEditing()

		@props.selection.setFutureCaret @props.chunk.get('index'), { groupIndex:'anchor:main', offset:0 }
		@props.updateFn()

	delete: ->
		chunk = @props.chunk
		chunk.revert @props.selection

		@props.updateFn()

	onAnchorKeyDown: (event) ->
		switch event.keyCode
			when Keyboard.ENTER
				event.preventDefault()
				@startEditing()
				return

	# shouldComponentUpdate: ->
	# 	@props.chunk.needsUpdate

	componentDidUpdate: ->
		@props.chunk.markUpdated()

	render: ->
		data = @props.chunk.componentContent

		contents = switch
			when @props.isEditing
				`<div className="edit">
					<Viewer {...this.props} />
					<SingleInputBubble label="YouTube Video ID" value={this.state.userVideoId} onChange={this.onChange} onClose={this.onClose} onCancel={this.onCancel} />
				</div>`
			when data.videoId
				`<img src={'https://i.ytimg.com/vi/' + data.videoId + '/hqdefault.jpg'} />`
			else
				`<div className="placeholder">Double click here to specify a YouTube video</div>`

		`<FocusableChunk onDoubleClick={this.startEditing} onKeyDown={this.onAnchorKeyDown} className={'obojobo-draft--chunks--you-tube editor' + (this.props.isEditing ? ' focus' : '')} shouldPreventTab={this.props.shouldPreventTab}>
			<div className="container outline-on-selection highlight-on-hover">
				{ !this.props.isEditing ? <DeleteButton onClick={this.delete} shouldPreventTab={this.props.shouldPreventTab} /> : null }
				{ !this.props.isEditing ? <EditButton onClick={this.startEditing} /> : null }
				{contents}
			</div>
		</FocusableChunk>`


module.exports = YouTube