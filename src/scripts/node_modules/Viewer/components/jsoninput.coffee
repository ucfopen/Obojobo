timeoutId = null

JSONInput = React.createClass
	getInitialState: ->
		value: @props.value
		open: false

	componentDidMount: ->
		document.body.removeChild(document.getElementById('--reset-all'))


	onClick: (event) ->
		@props.onChange @state.value

	onClickReset: ->
		if confirm('Are you sure you want to completely erase your JSON object and revert back to the example?')
			delete window.localStorage.__edit
			delete window.localStorage.stateData
			window.location.reload()

	onClickClear: ->
		delete window.localStorage.stateData
		window.location.reload()

	onChange: (event) ->
		json = event.target.value

		clearTimeout timeoutId
		timeoutId = setTimeout (->
			a = document.getElementById('alert')
			if(a)
				a.parentElement.removeChild(a)

			try
				o = JSON.parse(json)
				window.localStorage.__edit = json
				@props.onChange o

			catch e
				d = document.createElement('div')
				d.id = 'alert'
				p = document.createElement('p')
				p.innerText = 'Error parsing JSON: ' + e.toString()
				d.appendChild(p)
				d.style.position = "fixed"
				d.style.left = "10px"
				d.style.top = "10px"
				d.style.width = "300px"
				d.style.height = "300px"
				d.style.border = "3px solid red"
				d.style.zIndex = "9999999999"
				d.style.background = "white"
				document.body.appendChild(d)
				console.log(e)
				return
		).bind(@), 500

		@setState { value:event.target.value }

	onToggle: (event) ->
		newVal = !@state.open
		@setState { open:newVal }
		console.clear()
		console.log(document.getElementsByClassName('viewer--viewer-app')[0].classList)
		document.getElementsByTagName('html')[0].classList.toggle('--json-input-open')
		# @props.onToggle newVal

	render: ->
		#<button style={{position:'absolute',bottom:'10px',left:0,display:'block',width:'50%'}} onClick={this.onClick}>Update</button>
		#<button style={{display:'none';position:'absolute',bottom:'10px',left:'75%',display:'block',width:'25%'}} onClick={this.onClickClear}>Clear State</button>

		if(@state.open)
			return `<div style={{position:'fixed',right:0,top:0,bottom:0,width:'50%',background:'gray',zIndex:9999}}>
				<button style={{position:'absolute',top:'0',left:0,display:'block',width:'100%'}} onClick={this.onToggle}>Close</button>
				<textarea wrap='off' style={{position:'absolute',left:0,top:'20px',right:0,bottom:'40px',width:'100%', fontFamily:'monospace', fontSize:'10pt',padding:0,margin:0,boxSizing:'border-box'}} value={this.state.value} onChange={this.onChange} />
				<button style={{position:'absolute',bottom:'10px',left:'0%',display:'block',width:'25%'}} onClick={this.onClickReset}>Reset everything</button>

			</div>`

		return `<div style={{position:'fixed',right:0,top:0,zIndex:9999}}>
			<button onClick={this.onToggle}>Open</button>
		</div>`


module.exports = JSONInput