Chunk = require 'ObojoboDraft/Common/models/obomodel'

# Utility methods for dealing with chunks

send = (fn, chunkOrChunks, selection, data = []) ->
	if not (chunkOrChunks instanceof Array)
		return chunkOrChunks.callCommandFn fn, data

	chunks = chunkOrChunks
	results = []
	for chunk in chunks
		results.push chunk.callCommandFn fn, data

	results


deleteSelection = (selection) ->
	# vs = selection.virtual
	# type = vs.type


	# console.clear()
	# console.log 'deleteSelection'
	# console.log type

	return if selection.virtual.type is 'caret'
	# console.log JSON.stringify(selection.getSelectionDescriptor(), null, 2);
	# console.log 'con', vs.inbetween

	for node in selection.virtual.inbetween
		node.remove()

	selection.saveVirtualSelection()

	selection.startChunk.deleteSelection()
	selection.restoreVirtualSelection()

	if selection.virtual.type is 'chunkSpan'
		selection.endChunk.deleteSelection()
		if selection.endChunk.canMergeWith selection.startChunk
			selection.startChunk.merge selection.endChunk

	selection.virtual.collapse()





replaceTextsWithinSelection = (selection, newChunk, expandSelection = true) ->
	selection.virtual.start.chunk.addChildBefore newChunk

	if expandSelection
		selection.virtual.start.data.offset = 0
		end = selection.virtual.end
		end.data.offset = end.chunk.modelState.textGroup.get(end.data.groupIndex).text.length

	newChunk.replaceSelection()


activateStyle = (style, selection, styleBrush, data = null) ->
	if selection.virtual.type is 'caret'
		styleBrush.add style, selection.styles[style]?
	else
		if selection.styles[style]?
			send 'unstyleSelection', selection.virtual.all, selection, [style, data]
		else
			send 'styleSelection', selection.virtual.all, selection, [style, data]


module.exports = {
	send: send
	deleteSelection: deleteSelection
	activateStyle: activateStyle
	replaceTextsWithinSelection: replaceTextsWithinSelection
}