require './tablecontrols.scss'

TableMenu = require './tablemenu'

insertButton = require 'svg-url?noquotes!./assets/table-insert.svg'

Common = window.ObojoboDraft.Common

TableControls = React.createClass

	addRow: (event) ->
		event.preventDefault()
		event.stopPropagation()

		@props.addRow()

	addCol: (event) ->
		event.preventDefault()
		event.stopPropagation()

		@props.addCol()

	getCellPosition: (type, position) ->
		el = @props.chunk.getDomEl()
		bbox = @refs.self.getBoundingClientRect()

		cellBbox = switch type
			when 'row'
				cell = el.querySelector ".row-#{position}.col-0"
				cell.getBoundingClientRect()
			when 'col'
				cell = el.querySelector ".row-0.col-#{position}"
				cell.getBoundingClientRect()

		left:   cellBbox.left - bbox.left
		top:    cellBbox.top - bbox.top
		right:  cellBbox.right - bbox.right
		bottom: cellBbox.bottom - bbox.bottom
		width:  cellBbox.width
		height: cellBbox.height

	componentDidMount: ->
		@positionMenus()

	componentDidUpdate: ->
		@positionMenus()

	positionMenus: ->
		refs = @refs
		getCellPosition = @getCellPosition

		[0...@props.chunk.modelState.textGroup.numRows].map (index) ->
			el = ReactDOM.findDOMNode refs["menu_row_#{index}"]
			pos = getCellPosition 'row', index

			el.style.left = "#{pos.left}px"
			el.style.top  = "#{pos.top}px"

		[0...@props.chunk.modelState.textGroup.numCols].map (index) ->
			el = ReactDOM.findDOMNode refs["menu_col_#{index}"]
			pos = getCellPosition 'col', index

			el.style.left = "#{pos.left}px"
			el.style.top  = "#{pos.top}px"

	render: ->
		onTableMenuCommand = @props.onTableMenuCommand
		bgInsert = Common.util.getBackgroundImage insertButton
		getCellPosition = @getCellPosition

		rows = [0...@props.chunk.modelState.textGroup.numRows].map (index) ->
			`<TableMenu
				onMenuCommand={onTableMenuCommand}
				type="row"
				row={index}
				ref={'menu_row_' + index}
			/>`

		cols = [0...@props.chunk.modelState.textGroup.numCols].map (index) ->
			`<TableMenu
				onMenuCommand={onTableMenuCommand}
				type="col"
				col={index}
				ref={'menu_col_' + index}
			/>`

		`<div className="obojobo-draft--chunks--table--table-controls" ref="self">
			<div className="rows">{rows}</div>
			<div className="cols">{cols}</div>
			<button
				className="add-row"
				key='0'
				onMouseDown={this.addRow}
				style={{
					backgroundImage: bgInsert
				}}>
					Add a row
			</button>
			<button
				className="add-col"
				key='1'
				onMouseDown={this.addCol}
				style={{
					backgroundImage: bgInsert
				}}>
					Add a column
			</button>
		</div>`


module.exports = TableControls