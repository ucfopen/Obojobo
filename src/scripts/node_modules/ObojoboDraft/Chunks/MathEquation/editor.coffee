require './editor.scss'

Viewer = require './viewer'

# katex = null #dynamically load
katex = require 'katex'

Common = window.ObojoboDraft.Common
OBO = window.OBO
Editor = window.Editor

FocusableCommandHandler = Editor.chunk.focusableChunk.FocusableCommandHandler
SingleInputBubble = Common.components.modal.bubble.SingleInputBubble
FocusableChunk = Common.chunk.FocusableChunk
EditButton = Common.components.EditButton
DeleteButton = Common.components.DeleteButton
FocusableSelectionHandler = Common.chunk.focusableChunk.FocusableSelectionHandler

getLatexHtml = (latex) ->
	try
		html = katex.renderToString latex, { displayMode:true }
		html: html
	catch e
		error: e

commandHandler = new FocusableCommandHandler()
selectionHandler = new FocusableSelectionHandler()


MathEquation = React.createClass
	statics:
		type: 'ObojoboDraft.Chunks.MathEquation'
		register: ->
			OBO.registerChunk MathEquation, {
				dependencies: ['https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css']
				insertItem:
					label: 'Math Equation'
					icon: require('svg-url?noquotes!./assets/insert-icon.svg')
					onInsert: Common.chunk.util.Insert
			}

		DEFAULT_LATEX: ''
		getCommandHandler: -> commandHandler
		getSelectionHandler: -> selectionHandler

		createNewNodeData: Viewer.createNewNodeData
		cloneNodeData: Viewer.cloneNodeData
		createNodeDataFromDescriptor: Viewer.createNodeDataFromDescriptor
		getDataDescriptor: Viewer.getDataDescriptor

	getInitialState: ->
		latex = @props.chunk.modelState.latex
		result = getLatexHtml latex
		if result.error?
			latex = @DEFAULT_LATEX
			result = getLatexHtml latex
		katexHtml: result.html
		editing: null

	edit: ->
		if not @props.isEditing
			@props.editChunk @props.chunk

	componentWillReceiveProps: (nextProps) ->
		if nextProps.isEditing and not @props.isEditing
			latex = @props.chunk.modelState.latex

			@setState {
				editing:
					initialLatex: latex
					lastValidLatex: latex
					currentLatex: latex
					katexError: null
			}

	onChange: (newValue) ->
		@props.chunk.markDirty()
		data = @props.chunk.modelState
		data.latex = newValue
		editing = @state.editing

		result = getLatexHtml newValue

		if result.error?
			editing.katexError = result.error.toString()
			editing.currentLatex = newValue

			@setState {
				editing: editing
			}
		else
			editing.lastValidLatex = newValue
			editing.currentLatex = newValue
			editing.katexError = null

			@setState {
				editing: editing
				katexHtml: result.html
				chunk: @props.chunk
			}

	onCancel: ->
		@stopEditing @state.editing.initialLatex

	onClose: ->
		@stopEditing @state.editing.lastValidLatex

	stopEditing: (finalLatex) ->
		console.log 'stopEditing', finalLatex
		data = @props.chunk.modelState
		data.latex = finalLatex

		@props.chunk.markDirty()
		@setState {
			editing: null
			katexHtml: getLatexHtml(finalLatex).html
		}

		# @props.setTextMode on
		@props.stopEditing()

		# @props.selection.setFutureCaret @props.chunk.get('index'), { groupIndex:'anchor:main', offset:0 }
		# @props.selection.virtual.setCaret @props.chunk.get('index'), { groupIndex:'anchor:main', offset:0 }
		@props.chunk.selectStart()
		@props.saveAndRenderModuleFn()

	onAnchorKeyDown: (event) ->
		@props.onKeyDownPutChunkOnClipboard event, @props.chunk

		if event.keyCode is 13
			event.preventDefault()
			@edit()

	onDeleteButtonClick: (event) ->
		chunk = @props.chunk
		chunk.revert()
		chunk.selectStart()

		@props.saveAndRenderModuleFn()

	shouldComponentUpdate: ->
		@props.chunk.needsUpdate

	componentDidUpdate: ->
		@props.chunk.markUpdated()

	render: ->

		chunk = @props.chunk
		data = chunk.modelState
		hasError = this.state.editing?.katexError?
		isEmpty = data.latex is ''
		isEditing = @props.isEditing

		`<FocusableChunk className={'obojobo-draft--chunks--math-equation' + (this.state.editing ? '' : ' outline-on-selection highlight-on-hover')} onKeyDown={this.onAnchorKeyDown} onDoubleClick={this.edit} shouldPreventTab={this.props.shouldPreventTab}>
			<div className={( hasError ? ' error' : '' ) + ( isEmpty ? ' empty' : '' )}>
				{ hasError && isEditing ? <span className="error-msg">{this.state.editing.katexError}</span> : null }
				{ isEmpty ?
					<div className="katex-container"><div className="katex-display">({ isEditing ? 'Type an equation...' : 'Click edit to create a Latex equation'})</div></div>
					:
					<div className="katex-container" dangerouslySetInnerHTML={{__html:this.state.katexHtml}} />
				}
				{ isEditing ?
					<SingleInputBubble label="Edit latex equation" value={data.latex} onChange={this.onChange} onClose={this.onClose} onCancel={this.onCancel} />
					:
					<EditButton onClick={this.edit} shouldPreventTab={this.props.shouldPreventTab} />
				}
				{
					isEditing
					?
					null
					:
					<DeleteButton onClick={this.onDeleteButtonClick} shouldPreventTab={this.props.shouldPreventTab} />
				}
			</div>
		</FocusableChunk>`


MathEquation.register()

module.exports = MathEquation