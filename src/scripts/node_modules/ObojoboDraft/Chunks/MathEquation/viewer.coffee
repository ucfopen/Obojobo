require './viewer.scss'

# katex = null #dynamically load
katex = require 'katex'

Common = window.ObojoboDraft.Common
NonEditableChunk = Common.chunk.NonEditableChunk
FocusableSelectionHandler = Common.chunk.focusableChunk.FocusableSelectionHandler

selectionHandler = new FocusableSelectionHandler()

getLatexHtml = (latex) ->
	try
		html = katex.renderToString latex, { displayMode:true }
		html: html
	catch e
		error: e


MathEquation = React.createClass
	statics:
		type: 'ObojoboDraft.Chunks.MathEquation'
		register: ->
			OBO.registerChunk MathEquation, {
				dependencies: ['https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css']
			}

		DEFAULT_LATEX: ''
		getSelectionHandler: -> selectionHandler

		createNewNodeData: ->
			latex: @DEFAULT_LATEX

		cloneNodeData: (data) ->
			latex: data.latex

		createNodeDataFromDescriptor: (descriptor) ->
			content = descriptor.content

			latex: content.latex

		getDataDescriptor: (chunk) ->
			data = chunk.modelState

			latex: data.latex

	getInitialState: ->
		katexHtml = getLatexHtml @props.chunk.modelState.latex
		if katexHtml.error?
			katexHtml = ''
		else
			katexHtml = katexHtml.html

		katexHtml: katexHtml

	render: ->
		console.log 'RENDER', @props.chunk.modelState.latex, @state.katexHtml

		if @state.katexHtml.length is 0
			return null

		`<NonEditableChunk className="obojobo-draft--chunks--math-equation pad">
			<div className="katex-container" dangerouslySetInnerHTML={{__html:this.state.katexHtml}} />
		</NonEditableChunk>`


MathEquation.register()

module.exports = MathEquation