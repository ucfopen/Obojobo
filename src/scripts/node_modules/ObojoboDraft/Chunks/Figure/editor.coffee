require './editor.scss'
require './viewer.scss'

Viewer = require './viewer'

Common = window.ObojoboDraft.Common
OBO = window.OBO

TextCommandHandler = require './commandhandler'
SelectionHandler = require './selectionhandler'
Image = require './image'

TextGroup = Common.textGroup.TextGroup
TextGroupEl = Common.chunk.textChunk.TextGroupEl
Anchor = Common.components.Anchor
Chunk = Common.models.Chunk
DOMSelection = Common.selection.DOMSelection
Keyboard = Common.page.Keyboard
FocusableChunk = Common.chunk.FocusableChunk
SingleInputBubble = Common.components.modal.bubble.SingleInputBubble
ChunkUtil = Common.chunk.util.ChunkUtil
TextGroupSelection = Common.textGroup.TextGroupSelection
TextGroupSelectionHandler = Common.chunk.textChunk.TextGroupSelectionHandler
DeleteButton = Common.components.DeleteButton

# ToggleCommandHandler = Editor.chunk.focusableChunk.ToggleCommandHandler

# commandHandler = new ToggleCommandHandler(new TextCommandHandler())
commandHandler = new TextCommandHandler()
selectionHandler = new SelectionHandler()

sizes = ['small', 'medium', 'large']



Figure = React.createClass
	statics:
		type: 'ObojoboDraft.Chunks.Figure'
		register: ->
			OBO.registerChunk Figure, {
				insertItem:
					label: 'Figure'
					icon: require 'svg-url?noquotes!./assets/insert-icon.svg'
					onInsert: Common.chunk.util.Insert
			}
			OBO.registerToolbarItem {
				id: 'insertFigure'
				type: 'button'
				label: 'Insert Figure'
				icon: require 'svg-url?noquotes!./assets/toolbar-icon.svg'
				onClick: (toolbarItem, editorState) ->
					newChunk = Chunk.create Figure

					console.log 'BEFORE'
					__lo.__print()

					editorState.selection.startChunk.addChildBefore newChunk
					newChunk.replaceSelection()
					newChunk.selectStart()

					console.log 'AFTER'
					__lo.__print()
			}

		getCommandHandler: -> commandHandler
		getSelectionHandler: -> selectionHandler

		createNewNodeData: Viewer.createNewNodeData
		cloneNodeData: Viewer.cloneNodeData
		createNodeDataFromDescriptor: Viewer.createNodeDataFromDescriptor
		getDataDescriptor: Viewer.getDataDescriptor

	setSize: (size) ->
		@props.chunk.markDirty()

		data = @props.chunk.modelState
		data.size = size

		@props.saveAndRenderModuleFn()

	nextSize: (event) ->
		event.preventDefault()

		data = @props.chunk.modelState
		@setSize sizes[(sizes.indexOf(data.size) + 1) % sizes.length]

	onAnchorKeyDown: (event) ->
		@markChunkForUpdate()
		@props.onKeyDownPutChunkOnClipboard event, @props.chunk

		# switch event.keyCode
		# 	when Keyboard.DELETE, Keyboard.BACKSPACE
		# 		event.preventDefault()

		# 		newChunk = Chunk.create @
		# 		@props.chunk.replaceWith newChunk

		# 		newChunk.selectEnd @props.selection

	setImageURL: ->
		@props.chunk.markDirty()
		@props.editChunk @props.chunk

	onChange: (newValue) ->
		@props.chunk.markDirty()
		console.log 'YT on Change', newValue
		# @props.chunk.markDirty()
		# data = @props.chunk.modelState
		# data.videoId = newValue
		@setState { userImageURL:newValue }

	onClose: ->
		@props.chunk.markDirty()
		@props.chunk.modelState.url = @state.userImageURL

		@setState {
			chunk: @props.chunk
		}

		# @props.setTextMode on
		@props.stopEditing()

		@props.selection.virtual.setCaret @props.chunk.get('index'), { groupIndex:'anchor:main', offset:0 }
		@props.saveAndRenderModuleFn()

	onDeleteButtonClick: ->
		chunk = @props.chunk
		commandHandler._revert(chunk).selectEnd()

		@props.saveAndRenderModuleFn()

	componentWillReceiveProps: (nextProps) ->
		if @props.selectionState isnt nextProps.selectionState then @props.chunk.markForUpdate()

	shouldComponentUpdate: ->
		@props.chunk.needsUpdate

	componentDidUpdate: ->
		@props.chunk.markUpdated()

	markChunkForUpdate: ->
		@props.chunk.markForUpdate()

	render: ->
		data = @props.chunk.modelState

		focus = 'none'
		pos = @props.selectionState
		if pos is 'contains' or pos is 'start' or pos is 'inside' or pos is 'end'
			focus = switch @props.selection.virtual.start.data.groupIndex
				when 'anchor:main' then 'anchor'
				else 'caption'

		`<FocusableChunk
			className={'obojobo-draft--chunks--figure editor ' + data.size}
			ref="component"
			onClick={this.markChunkForUpdate}
			onFocus={this.markChunkForUpdate}
			onBlur={this.markChunkForUpdate}
			onKeyDown={this.onAnchorKeyDown}
			shouldPreventTab={this.props.shouldPreventTab}
		>
			<figure
				className={(data.textGroup.first.text.length === 0 && focus !== 'caption' ? 'empty-caption' : '') + ' focus-' + focus}
				onClick={this.markChunkForUpdate}
				unselectable="on"
			>
				<div className={'container highlight-on-hover' + (focus === 'anchor' ? ' outline-on-selection' : '')} ref="container">
					<Image chunk={this.props.chunk} />

					<div className="size-controls">
						<button onMouseDown={this.nextSize}>Size</button>
					</div>
					<div className="img-controls">
						<button onMouseDown={this.setImageURL}>Set image from URL</button>
						<button onMouseDown={this.todo}>Upload image</button>
					</div>
					{ !this.props.isEditing && focus === 'anchor' ? <DeleteButton onClick={this.onDeleteButtonClick} shouldPreventTab={this.props.shouldPreventTab} /> : null }
				</div>
				<figcaption
					className="pad"
					contentEditable="true"
					suppressContentEditableWarning={true}
					ref="caption"
					tabIndex={this.props.shouldPreventTab ? '-1' : ''}
				>
					<TextGroupEl text={data.textGroup.first.text} groupIndex="0" />
				</figcaption>
			</figure>
			{
				this.props.isEditing
				?
				<SingleInputBubble
					label="Image URL"
					value={this.state.userImageURL}
					onChange={this.onChange}
					onClose={this.onClose}
					onCancel={this.onCancel}
				/>
				:
				null
			}
		</FocusableChunk>`


Figure.register()

module.exports = Figure